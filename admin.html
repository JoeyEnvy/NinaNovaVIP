<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Nina Nova TV — Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="images/download.svg" type="image/svg+xml">
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter+Tight:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter Tight',system-ui,sans-serif;
      background:#07070b;
      color:#f4f4f8;
      height:100vh;
      overflow:hidden;
    }
    header{
      height:54px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      background:rgba(10,10,16,.85);
      border-bottom:1px solid rgba(255,255,255,.08);
      backdrop-filter:blur(12px);
      position:fixed;
      top:0;left:0;right:0;
      z-index:10;
    }
    header .brand{
      font-family:'Anton',sans-serif;
      font-size:1.4rem;
    }
    header span{color:#ff4fa0}
    header em{font-style:normal;color:#ff8c32}
    header nav button{
      background:none;
      border:none;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      opacity:.7;
      margin-left:14px;
    }
    header nav button.active{opacity:1}
    #wrapper{
      display:flex;
      height:100%;
      padding-top:54px;
    }
    #sessions{
      width:320px;
      background:#0f0f18;
      border-right:1px solid rgba(255,255,255,.08);
      overflow-y:auto;
    }
    .session{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
    }
    .session:hover{background:#161622}
    .session.active{background:#1a1a2e}
    #main{
      flex:1;
      padding:24px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
    }
    .msg{
      margin-bottom:12px;
      padding:10px 14px;
      border-radius:14px;
      max-width:70%;
      align-self:flex-start;
    }
    .user{
      margin-left:auto;
      background:#2b2b3f;
      align-self:flex-end;
    }
    .assistant{
      background:#412060;
    }
    .inject-box{
      margin-top:auto;
      padding-top:20px;
      border-top:1px solid rgba(255,255,255,.1);
    }
    .inject-input{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .inject-input input{
      flex:1;
      padding:12px 16px;
      background:rgba(255,255,255,.08);
      border:none;
      border-radius:12px;
      color:#fff;
    }
    .inject-input button{
      padding:12px 20px;
      background:#ff4fa0;
      border:none;
      border-radius:12px;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
    }
    th,td{
      text-align:left;
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:.9rem;
    }
    th{opacity:.7}
  </style>
</head>
<body>
<header>
  <div class="brand">Nina<span>Nova</span><em>TV</em> — Admin</div>
  <nav>
    <button id="tabChat" class="active">Chats</button>
    <button id="tabAnalytics">Analytics</button>
  </nav>
</header>
<div id="wrapper">
  <div id="sessions"></div>
  <div id="main">Loading…</div>
</div>
<script>
const params = new URLSearchParams(location.search);
const KEY = params.get("key");
if (!KEY) {
  document.body.innerHTML = "<h2 style='padding:40px'>Missing admin key</h2>";
  throw new Error("No key");
}

const sessionsEl = document.getElementById("sessions");
const mainEl = document.getElementById("main");
const tabChat = document.getElementById("tabChat");
const tabAnalytics = document.getElementById("tabAnalytics");

let currentSessionId = null;

tabChat.onclick = () => loadChats();
tabAnalytics.onclick = () => loadAnalytics();

function setTab(active){
  tabChat.classList.toggle("active", active==="chat");
  tabAnalytics.classList.toggle("active", active==="analytics");
}

function renderMessages(msgs) {
  const chatHTML = msgs.map(m =>
    `<div class="msg ${m.role}">${m.content}</div>`
  ).join("");

  const injectBox = currentSessionId ? `
    <div class="inject-box">
      <small style="opacity:.7">Send as Nina</small>
      <div class="inject-input">
        <input type="text" id="inject-text" placeholder="Type message..." />
        <button id="inject-send">Send</button>
      </div>
    </div>
  ` : "";

  mainEl.innerHTML = `
    <div style="flex:1;overflow-y:auto;padding-bottom:20px;">
      ${chatHTML || "<em>No messages yet</em>"}
    </div>
    ${injectBox}
  `;

  // Scroll to bottom
  mainEl.scrollTop = mainEl.scrollHeight;

  // Inject handler
  if (currentSessionId) {
    const injectInput = document.getElementById("inject-text");
    const injectBtn = document.getElementById("inject-send");

    const sendInject = () => {
      const text = injectInput.value.trim();
      if (!text) return;
      fetch("https://ninanovavip-backend.onrender.com/admin/inject", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key: KEY, sessionId: currentSessionId, message: text })
      })
      .then(r => r.json())
      .then(res => {
        if (res.success) {
          renderMessages([...msgs, { role: "assistant", content: text }]);
          injectInput.value = "";
        } else {
          alert("Failed to send");
        }
      })
      .catch(() => alert("Error"));
    };

    injectBtn.onclick = sendInject;
    injectInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendInject();
      }
    });
  }
}

function loadChats(){
  setTab("chat");
  fetch(`https://ninanovavip-backend.onrender.com/admin/conversations?key=${KEY}`)
    .then(r => r.json())
    .then(data => {
      sessionsEl.innerHTML = "";
      mainEl.innerHTML = "Select a conversation";

      const entries = Object.entries(data).sort((a,b) => b[1].length - a[1].length);

      entries.forEach(([id, msgs]) => {
        const div = document.createElement("div");
        div.className = "session";
        div.textContent = `${id.slice(0,8)}… (${msgs.length} msgs)`;
        div.onclick = () => {
          currentSessionId = id;
          document.querySelectorAll(".session").forEach(s => s.classList.remove("active"));
          div.classList.add("active");
          renderMessages(msgs);
        };
        sessionsEl.appendChild(div);
      });
    });
}

function loadAnalytics(){
  setTab("analytics");
  sessionsEl.innerHTML = "";
  mainEl.innerHTML = "Loading analytics…";
  fetch(`https://ninanovavip-backend.onrender.com/admin/analytics?key=${KEY}`)
    .then(r => r.json())
    .then(data => {
      const counts = {};
      data.sessions && Object.values(data.sessions).flat().forEach(e => {
        const k = `${e.page || "unknown"} → ${e.target || e.type}`;
        counts[k] = (counts[k] || 0) + 1;
      });
      mainEl.innerHTML = `
        <h2>Analytics Overview</h2>
        <table>
          <tr><th>Event</th><th>Count</th></tr>
          ${Object.entries(counts)
            .sort((a,b) => b[1] - a[1])
            .map(([k,v]) => `<tr><td>${k}</td><td>${v}</td></tr>`)
            .join("")}
        </table>
      `;
    });
}

loadChats();
</script>
</body>
</html>